<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>MERIT Terracotta Viewer</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    .elev-readout {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      border-radius: 4px;
      font: 12px/1.4 system-ui, -apple-system, sans-serif;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .tile-label {
      font: 11px/1.1 system-ui, -apple-system, sans-serif;
      color: #0a2a4a;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(10, 42, 74, 0.3);
      border-radius: 3px;
      padding: 1px 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
    .leaflet-control-base-switcher {
      background: linear-gradient(135deg, rgba(10, 24, 58, 0.92), rgba(8, 68, 110, 0.9));
      padding: 4px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.25);
      box-shadow: 0 15px 30px rgba(3, 6, 30, 0.45);
    }
    .leaflet-control-base-switcher button {
      border: none;
      margin: 0 2px;
      padding: 6px 14px;
      border-radius: 12px;
      font: 12px/1.3 "Space Mono", "IBM Plex Mono", monospace;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.12);
      color: #e8f3ff;
      transition: all 0.2s ease;
    }
    .leaflet-control-base-switcher button:hover,
    .leaflet-control-base-switcher button.is-active {
      background: rgba(255, 255, 255, 0.95);
      color: #032341;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }
  </style>
</head>
<body>
<div id="map"></div>
<div class="elev-readout" id="elevReadout">Move mouse over map…</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([42.5, -58.0], 6);
  const elevEl = document.getElementById('elevReadout');
  const apiBase = 'http://127.0.0.1:8000';

  const baseLayers = {
    osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }),
    sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: 'Tiles &copy; Esri'
    })
  };

  const switchBaseLayer = (key) => {
    Object.values(baseLayers).forEach((layer) => {
      if (map.hasLayer(layer)) {
        map.removeLayer(layer);
      }
    });
    if (baseLayers[key]) {
      baseLayers[key].addTo(map);
    }
  };

  baseLayers.osm.addTo(map);

  const BaseSwitcherControl = L.Control.extend({
    options: { position: 'topleft' },
    onAdd() {
      const container = L.DomUtil.create('div', 'leaflet-control-base-switcher');
      this._buttons = {};
      const specs = [
        { key: 'osm', label: 'OSM' },
        { key: 'sat', label: 'Satellite' }
      ];
      specs.forEach(({ key, label }) => {
        const btn = L.DomUtil.create('button', '', container);
        btn.type = 'button';
        btn.textContent = label;
        btn.dataset.layer = key;
        if (key === 'osm') {
          btn.classList.add('is-active');
        }
        L.DomEvent.on(btn, 'click', () => {
          if (btn.classList.contains('is-active')) return;
          switchBaseLayer(key);
          Object.values(this._buttons).forEach((b) => b.classList.remove('is-active'));
          btn.classList.add('is-active');
        });
        this._buttons[key] = btn;
      });
      L.DomEvent.disableClickPropagation(container);
      return container;
    }
  });

  map.addControl(new BaseSwitcherControl());

  L.tileLayer(
    'http://127.0.0.1:8080/singleband/n40w060/{z}/{x}/{y}.png',
    { maxZoom: 12 }
  ).addTo(map);

  const canadaBounds = [
    [41.0, -80.0],
    [63.0, -55.0]
  ];

  L.rectangle(canadaBounds, {
    color: '#ff3b30',
    weight: 2,
    fill: false,
    dashArray: '6 6'
  }).addTo(map);

  function parseTileId(tileId) {
    const match = /^([ns])(\d{2})([ew])(\d{3})/.exec(tileId);
    if (!match) return null;
    const latSign = match[1] === 's' ? -1 : 1;
    const lonSign = match[3] === 'w' ? -1 : 1;
    const lat = latSign * Number(match[2]);
    const lon = lonSign * Number(match[4]);
    return { lat, lon };
  }

  function tileBounds(tileId) {
    const parsed = parseTileId(tileId);
    if (!parsed) return null;
    const { lat, lon } = parsed;
    return [
      [lat, lon],
      [lat + 5, lon + 5]
    ];
  }

  async function addDatasetBounds() {
    try {
      const resp = await fetch('http://127.0.0.1:8080/datasets');
      if (!resp.ok) return;
      const json = await resp.json();
      const datasets = Array.isArray(json.datasets) ? json.datasets : [];
      datasets.forEach((ds) => {
        const tileId = ds.tile || ds.name || ds.id;
        if (!tileId) return;
        const bounds = tileBounds(tileId);
        if (!bounds) return;
        L.rectangle(bounds, {
          color: '#007aff',
          weight: 1,
          fill: false,
          opacity: 0.9
        })
          .addTo(map)
          .bindTooltip(tileId, {
            permanent: true,
            direction: 'center',
            className: 'tile-label'
          });
      });
    } catch (err) {
      // Ignore if terracotta is not running.
    }
  }

  addDatasetBounds();

  const switcherButtons = document.querySelectorAll('.base-switcher__button');
  switcherButtons.forEach((button) => {
    button.addEventListener('click', () => {
      if (button.classList.contains('is-active')) return;
      switcherButtons.forEach((btn) => {
        btn.classList.remove('is-active');
        btn.setAttribute('aria-pressed', 'false');
      });
      button.classList.add('is-active');
      button.setAttribute('aria-pressed', 'true');
      Object.values(baseLayers).forEach((layer) => {
        if (map.hasLayer(layer)) {
          map.removeLayer(layer);
        }
      });
      const target = button.dataset.layer;
      if (baseLayers[target]) {
        baseLayers[target].addTo(map);
      }
    });
  });

  let pending = null;
  let lastLatLng = null;

  function formatElev(json) {
    if (json.nodata) return 'nodata';
    if (json.elevation_m === null || json.elevation_m === undefined) return 'null';
    return `${json.elevation_m.toFixed(2)} m`;
  }

  map.on('mousemove', (e) => {
    lastLatLng = e.latlng;
    if (pending) return;
    pending = setTimeout(async () => {
      const { lat, lng } = lastLatLng;
      try {
        const resp = await fetch(`${apiBase}/elevation?lat=${lat}&lng=${lng}`);
        if (!resp.ok) {
          elevEl.textContent = `lat ${lat.toFixed(4)}, lng ${lng.toFixed(4)} — error`;
        } else {
          const json = await resp.json();
          elevEl.textContent = `lat ${lat.toFixed(4)}, lng ${lng.toFixed(4)} — ${formatElev(json)}`;
        }
      } catch (err) {
        elevEl.textContent = `lat ${lat.toFixed(4)}, lng ${lng.toFixed(4)} — error`;
      } finally {
        pending = null;
      }
    }, 150);
  });
</script>
</body>
</html>
